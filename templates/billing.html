<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="bg-info">
    <div class="container mt-4 bg-light p-4 rounded">
        <h2 class="text-center">Billing System</h2>

        <!-- Customer Details -->
        <div class="border p-3 mb-3">
            <h4>Customer Details</h4>
            <form id="billing-form">
                <div class="row mb-2">
                    <div class="col">
                        <label for="customer_name" class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="customer_name" required>
                    </div>
                    <div class="col">
                        <label for="bus_number" class="form-label">Bus Number</label>
                        <input type="text" class="form-control" id="bus_number" required>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col">
                        <label for="bill_number" class="form-label">Bill Number</label>
                        <input type="text" class="form-control" id="bill_number" value="00003" readonly>
                    </div>
                    <div class="col">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" value="2025-03-16">
                    </div>
                </div>
            </form>
        </div>

        <!-- Item Details -->
        <div class="border p-3 mb-3">
            <h4>Item Details</h4>
            <div class="row">
                <div class="col">
                    <label for="item_name_input" class="form-label">Item Name</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="item_name_input" placeholder="Item Name">
                        <button class="btn btn-outline-secondary" type="button" id="start_speech">ðŸŽ¤</button>
                    </div>
                </div>
                <div class="col">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" class="form-control" id="quantity" value="1" min="1">
                </div>
                <div class="col">
                    <label for="price" class="form-label">Price</label>
                    <input type="number" class="form-control" id="price" value="0" min="0" step="0.01">
                </div>
                <div class="col align-self-end">
                    <button class="btn btn-primary" id="add_item">Add Item</button>
                </div>
            </div>
        </div>

        <!-- Added Items -->
        <div class="border p-3">
            <h4>Added Items</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Item Name</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="items_table">
                    <!-- Dynamic Rows -->
                </tbody>
            </table>
        </div>

        <!-- Total Amount -->
        <div class="text-end mt-3">
            <h4>Total Amount: <span id="total_amount">0.00</span></h4>
        </div>

        <button class="btn btn-success mt-3" id="generate_bill">Generate Bill</button>
    </div>

    <script>
        $(document).ready(function () {
            let itemCount = 0;

            // Add Item
            $("#add_item").click(function (e) {
                e.preventDefault();
                let itemName = $("#item_name_input").val().trim();
                let quantity = parseInt($("#quantity").val());
                let price = parseFloat($("#price").val());

                if (!itemName || quantity <= 0 || price < 0) {
                    alert("Please enter valid item details.");
                    return;
                }

                let total = (quantity * price).toFixed(2);
                itemCount++;
                $("#items_table").append(
                    `<tr>
                        <td>${itemCount}</td>
                        <td>${itemName}</td>
                        <td>${quantity}</td>
                        <td>${price.toFixed(2)}</td>
                        <td>${total}</td>
                        <td><button class='btn btn-danger btn-sm delete-item'>Delete</button></td>
                    </tr>`
                );
                $("#item_name_input, #quantity, #price").val("");
                $("#quantity").val(1);
                updateTotalAmount();
            });

            // Delete Item
            $(document).on("click", ".delete-item", function () {
                $(this).closest("tr").remove();
                updateTotalAmount();
            });

            // Update Total Amount
            function updateTotalAmount() {
                let totalAmount = 0;
                $("#items_table tr").each(function () {
                    totalAmount += parseFloat($(this).find("td:eq(4)").text()) || 0;
                });
                $("#total_amount").text(totalAmount.toFixed(2));
            }
            $("#generate_bill").click(function () {
                let formData = {
                    customer_name: $("#customer_name").val(),
                    bus_number: $("#bus_number").val(),
                    bill_number: $("#bill_number").val(),
                    date: $("#date").val(),
                    items: []
                };

                // Collect items from the table
                $("#items_table tr").each(function () {
                    let row = $(this).find("td");
                    if (row.length > 0) {
                        formData.items.push({
                            name: row.eq(1).text(),
                            quantity: row.eq(2).text(),
                            price: row.eq(3).text(),
                            total: row.eq(4).text()
                        });
                    }
                });

                // Send data to the server
                $.ajax({
                    url: "/generate_pdf",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function (response) {
                        // Open the generated PDF in a new tab
                        window.open(response, "_blank");
                    },
                    error: function (xhr, status, error) {
                        console.error("Error generating PDF:", error);
                        alert("Failed to generate PDF. Please try again.");
                    }
                });
            });

            // Speech Recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                $("#start_speech").click(() => {
                    recognition.start();
                    $("#start_speech").text("Listening...");
                });
                recognition.onresult = (event) => {
                    $("#item_name_input").val(event.results[0][0].transcript);
                    $("#start_speech").text("ðŸŽ¤");
                };
                recognition.onerror = () => $("#start_speech").text("ðŸŽ¤");
                recognition.onend = () => $("#start_speech").text("ðŸŽ¤");
            } else {
                $("#start_speech").hide();
            }
        });
    </script>
</body>

</html>